<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Garage Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
    </script>
<style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-bottom: 40px;
        }
        canvas {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        table {
            width: 50%;
            margin: 0 auto 40px auto; /* centrirano i ispod grafikona */
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-weight: 600;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        th {
            background: #2196f3;
            color: white;
            font-weight: 700;
        }

        #occupancyChart, #revenueChart {
            max-width: 500px;
            max-height: 500px;
            margin: 0 auto;
        }

        #typeChart {
            display: block;
            max-width: 900px;
            max-height: 500px;
            margin: 0 auto 40px auto; /* centriran + razmak ispod */
        }

        .chart-box {
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
}

.chart-box h2 {
    margin-bottom: 10px;
    font-size: 20px;
    font-weight: 700;
}

.chart-box canvas {
    width: 100%;
    max-height: 500px;
}   

button:hover {
    background-color: #45a049;
}

@media (max-width: 768px) {
    .grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <h1>Garage Dashboard</h1>
    <div style="text-align:center; margin:30px 0;">
        <button onclick="triggerSimulation()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">
            üîÑ Simulate Entry/Exit
        </button>
        <div id="statusMessage" style="text-align:center; font-weight:600; color:#d32f2f; margin-bottom:20px;"></div>
    </div>
    <div class="grid">
    <div>
        <h2>üìä Occupancy</h2>        
        <canvas id="occupancyChart"></canvas>
    </div>
    <div>
    <h2>üöó Types Vehicles</h2>
    <canvas id="typeChart"></canvas>
    </div>
    <div>
        <h2>üí∞ Revenue</h2>
        <canvas id="revenueChart"></canvas>
    </div>
    </div>



    <h2>üìã Active Vehicles</h2>
    <table id="vehiclesTable">
        <thead>
            <tr>
                <th>Type</th>
                <th>Registration</th>
                <th>Entry Time</th>
                <th>Barcode</th>
            </tr>
        </thead>
        <tbody>
            <!-- Popuniƒáe se iz JS-a -->
        </tbody>
    </table>

    <script>
        Chart.defaults.font.size = 20;
        Chart.defaults.font.weight = '600';

        //const API_BASE = 'http://127.0.0.1:8000';
        const API_BASE = location.hostname === 'localhost' ? 'http://127.0.0.1:8000' : '';

        let occupancyChart, typeChart, revenueChart; // globalne reference

        async function fetchJSON(path) { // funkcija za GET zahteve
            const res = await fetch(API_BASE + path);
            return res.ok ? res.json() : {};
        }

        async function loadDashboard() { // glavna funkcija za uƒçitavanje podataka
            // 1) Occupancy
            const freeData = await fetchJSON('/spaces/free');
            const occData = await fetchJSON('/occupancy');
            const occupied = occData.capacity - freeData.free_spaces;
            renderOccupancyChart(occupied, freeData.free_spaces, occData.capacity);

            // 2) Vehicles
            const vehicles = await fetchJSON('/vehicles/active');
            renderVehiclesTable(vehicles); // popunjavanje tabele
            renderTypeChart(vehicles); // grafikon po tipu vozila

            // 3) Revenue
            const revData = await fetchJSON('/revenue/today'); 
            renderRevenueChart(revData.total_revenue || 0); // grafikon prihoda
        }

        function renderOccupancyChart(occupied, free, capacity) {
            if (occupied >= capacity) {
                document.getElementById("statusMessage").textContent = "‚ö†Ô∏è Parking je pun. Nema slobodnih mesta.";
            }

            if (occupancyChart) occupancyChart.destroy();  // uni≈°tavamo prethodni grafikon ako postoji
            occupancyChart = new Chart(
                document.getElementById('occupancyChart'),
                {
                    type: 'doughnut',
                    data: {
                        labels: ['Occupied', 'Free'],
                        datasets: [{
                            data: [occupied, free],
                            backgroundColor: ['#f44336', '#4caf50']
                        }]
                    },
                    options: { responsive: true }
                }
            );
        }

        function renderVehiclesTable(list) {
            const tbody = document.querySelector('#vehiclesTable tbody');
            tbody.innerHTML = '';
            list.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.type}</td>
                    <td>${v.registration}</td>
                    <td>${v.entry_time}</td>
                    <td>${v.barcode}</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderTypeChart(list) {
            if (typeChart && typeof typeChart.destroy === "function") {
                typeChart.destroy();
            }
            const counts = list.reduce((acc, v) => {  // count by type
                acc[v.type] = (acc[v.type] || 0) + 1;
                return acc;
            }, {});
            const types = Object.keys(counts);
            const data = Object.values(counts);

            typeChart = new Chart(
                document.getElementById('typeChart'),
                {
                    type: 'bar',
                    data: {
                        labels: types,
                        datasets: [{ label: 'Count', data, backgroundColor: '#2196f3' }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                }
            );
        }

        function renderRevenueChart(amount) {
            if (revenueChart && typeof revenueChart.destroy === "function") {
                revenueChart.destroy();  // uni≈°tavamo prethodni grafikon ako postoji
            }
            revenueChart = new Chart(
                document.getElementById('revenueChart'),
                {
                    type: 'bar',
                    data: {
                        labels: ['Today'],
                        datasets: [{
                            label: 'RSD',
                            data: [amount],
                            backgroundColor: '#ff9800'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: v => v.toLocaleString('sr-RS') + ' RSD'
                                }
                            }
                        }
                    }
                }
            );
        }

        loadDashboard();

        function triggerSimulation() {
            fetch('/simulate', { method: 'POST' })
             .then(res => res.json())
                .then(data => {
                    if (data.error) {
                            document.getElementById("statusMessage").textContent = "‚ùå " + data.error;
                    } else {
                            document.getElementById("statusMessage").textContent = "‚úÖ Simulacija uspe≈°no pokrenuta!";
                            loadDashboard(); // ne mora≈° reload, mo≈æe≈° samo osve≈æiti podatke
                                     }
                                 })
                                 .catch(err => {
            document.getElementById("statusMessage").textContent = "‚ùå Gre≈°ka u komunikaciji sa serverom.";
        });
}

    </script>
</body>
</html>
